<?xml version="1.0"?>

<project name="@applicationName@" default="all" basedir=".">
	
	<property name="output.dir" value="${basedir}/build"/>
	<property name="classes.dir" value="${output.dir}/classes"/>

	<property name="src" value="${basedir}/src"/>

	<property name="lib.project" value="${basedir}/lib"/>
	<property name="lib.shared" value="${basedir}/../ano-libs/lib"/>

	<property name="etc" value="${basedir}/etc"/>
	<property name="html" value="${basedir}/html"/>

	<property name="tld" value="${etc}/tld"/>
	<property name="appdata" value="${etc}/appdata"/>

	<property name="generation.output" value="${basedir}/generated"/>	

	<property name="gen.appdata" value="${generation.output}/etc/appdata"/>
	
	<property name="dist.dir" value="${basedir}/dist"/>
	<property name="lib.dest" value="${dist.dir}/lib"/>
	
	<property name="javadoc.dest" value="${basedir}/../javadoc"/>
	
	<property name="project.name" value="@applicationName@"/>
	<property name="target.jar.name" value="@applicationName@.jar"/>
	
	<property name="webapp.dir" value="/opt/small-tomcat/webapps"/>
	
	<property name="webapp.name" value="@applicationURLPath@"/>
	<property name="webapp.tmp.dir" value="${output.dir}/webapp/${webapp.name}"/>
	<property name="webapp.lib" value="${webapp.tmp.dir}/WEB-INF/lib"/>
	<property name="webapp.tld" value="${webapp.tmp.dir}/WEB-INF/tld"/>
	<property name="webapp.classes" value="${webapp.tmp.dir}/WEB-INF/classes"/>
	<property name="webapp.appdata" value="${webapp.tmp.dir}/WEB-INF/appdata"/>

	<target name="clean" depends="generate.clean">
		<delete dir="${output.dir}"/>
	</target>

	<target name="prepare">
		<mkdir dir="${dist.dir}"/>
		<mkdir dir="${classes.dir}"/>
	</target>
	
	<target name="compile" depends="prepare">
		<javac destdir="${classes.dir}" srcdir="${src}" debug="on" deprecation="off" optimize="on" compiler="modern">
			<classpath>
				<fileset dir="${lib.project}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${lib.shared}">
					<include name="**/*.jar"/>
				</fileset>
			</classpath>
		</javac>
	</target>
		
	<target name="copy" depends="prepare">
		<copy toDir="${classes.dir}">
			<fileset dir="${src}">
				<include name="**/*.jsp"/>
				<include name="**/*.js"/>
				<include name="**/*.csv"/>
			</fileset>
		</copy>
		<copy toDir="${classes.dir}">
			<fileset dir="${generation.output}/java">
				<include name="**/*.jsp"/>
			</fileset>
		</copy>
		<copy toDir="${classes.dir}" >
			<fileset dir="${gen.appdata}">
				<include name="**/struts-config-*"/>
				<exclude name="**/struts-config.xml"/>
			</fileset>
			<fileset dir="${appdata}">
				<include name="**/struts-config-*"/>
				<exclude name="**/struts-config.xml"/>
			</fileset>
		</copy>
		<copy toDir="${classes.dir}">
			<fileset dir="${appdata}">
				<include name="**/filestorage.properties"/>
				<include name="**/anodoc.storage.properties"/>
			</fileset>
		</copy>
	</target>

	<target name="copy.webapp" depends="prepare.webapp">
		<copy toDir="${webapp.classes}">
			<fileset dir="${src}">
				<include name="**/*.jsp"/>
				<include name="**/*.js"/>
			</fileset>
		</copy>
		<copy toDir="${webapp.classes}">
			<fileset dir="${generation.output}/java">
				<include name="**/*.jsp"/>
			</fileset>
		</copy>
		<copy toDir="${webapp.classes}" >
			<fileset dir="${gen.appdata}">
				<include name="**/struts-config-*"/>
				<exclude name="**/struts-config.xml"/>
			</fileset>
			<fileset dir="${appdata}">
				<include name="**/struts-config-*"/>
				<exclude name="**/struts-config.xml"/>
			</fileset>
		</copy>
		<copy toDir="${classes.dir}">
			<fileset dir="${appdata}">
				<include name="**/filestorage.properties"/>
				<include name="**/anodoc.storage.properties"/>
			</fileset>
		</copy>
	</target>

	<target name="generate.clean">
		<ant antfile="generate.xml" target="clean"/>
	</target>

	<target name="generate">
		<ant antfile="generate.xml" target="all"/>
	</target>
	
	<target name="buildapp" depends="generate,compile,copy"/>
	
	<target name="build.app" depends="generate,compile,copy"/>
	
	<target name="jar">
		<jar jarfile="${dist.dir}/${target.jar.name}">
         	<fileset dir="${classes.dir}">
         		<!--include name="**/*"/-->
         		<exclude name="net/anotheria/anosite/gen/**"/>
         	</fileset>
		</jar>
	</target>
	
	<target name="jar.app">
		<jar jarfile="${dist.dir}/${target.jar.name}">
         	<fileset dir="${classes.dir}"/>
		</jar>
	</target>
	
	<target name="clean.webapp">
		<delete dir="${webapp.tmp.dir}"/>
	</target>
	
	<target name="prepare.webapp">
		<mkdir dir="${webapp.tmp.dir}"/>
		<mkdir dir="${webapp.lib}"/>
		<mkdir dir="${webapp.tld}"/>
		<mkdir dir="${webapp.classes}"/>
				
		<!--copy file="${etc}/web.xml" todir="${webapp.tmp.dir}/WEB-INF"/-->
    	<!--copy file="${etc}/context.xml" tofile="${webapp.tmp.dir}/META-INF/context.xml"/-->

		<copy toDir="${webapp.tmp.dir}">
			<fileset dir="${html}">
				<include name="**/*"/>
			</fileset>
		</copy>
		<!-- copy tld's -->
		<copy toDir="${webapp.tld}" flatten="true"> 
			<fileset dir="${tld}">
				<include name="**/*.tld"/>
				<!--include name="**/*.dtd"/-->
			</fileset>
		</copy>
		
		<!-- copy libs -->
		<copy toDir="${webapp.lib}" flatten="true"> 
			<fileset dir="${lib.project}">
				<include name="**/*.jar"/>
				<exclude name="**/moskito-demo.jar"/>
				<exclude name="**/servlet-api.jar"/>
				<exclude name="**/jsp-api.jar"/>
				<exclude name="**/*-src.jar"/>
				<exclude name="**/moskito-webui-jsps.jar"/>
			</fileset>
			<fileset dir="${lib.shared}">
				<include name="**/*.jar"/>
				<exclude name="**/moskito-demo.jar"/>
				<exclude name="**/servlet-api.jar"/>
				<exclude name="**/jsp-api.jar"/>
				<exclude name="**/*-src.jar"/>
				<exclude name="**/moskito-webui-jsps.jar"/>
			</fileset>
				
		</copy>
		<!-- copy configs and properties -->
		<copy toDir="${webapp.classes}" flatten="true"> 
			<fileset dir="${appdata}">
				<include name="**/*.xml"/>
				<include name="**/*.properties"/>
			</fileset>
		</copy>
		<copy toDir="${webapp.classes}" flatten="true" >
			<fileset dir="${gen.appdata}">
				<include name="**/struts-config-*"/>
				<exclude name="**/struts-config.xml"/>
			</fileset>
		</copy>
		
		<copy toDir="${webapp.appdata}" flatten="true"> 
			<fileset dir="${appdata}">
				<include name="**/*.xml"/>
				<include name="**/*.properties"/>
				<include name="**/*.drl"/>
			</fileset>
		</copy>
	</target>
	
	<target name="jsps.webapp" depends="prepare.webapp">
		<copy toDir="${webapp.tmp.dir}">
			<fileset dir="${src}">
				<include name="**/*.jsp"/>
				<include name="**/*.js"/>
			</fileset>
			<fileset dir="${generation.output}/java">
				<include name="**/*.jsp"/>
			</fileset>
		</copy>
	</target>
	
	<target name="compile.webapp.g" depends="prepare.webapp">
		<javac destdir="${webapp.classes}" srcdir="${generation.output}" debug="on" deprecation="off" optimize="on">
			<classpath>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${lib.project}">
					<include name="**/servlet-api.jar"/>
					<include name="**/jsp-api.jar"/>
				</fileset>
				<fileset dir="${lib.shared}">
					<include name="**/servlet-api.jar"/>
					<include name="**/jsp-api.jar"/>
				</fileset>
			</classpath>
		</javac>
	</target>
	
	<target name="compile.webapp" depends="prepare.webapp">
		<javac destdir="${webapp.classes}" srcdir="${src}" debug="on" deprecation="off" optimize="on">
			<classpath>
				<fileset dir="${webapp.lib}">
					<include name="**/*.jar"/>
				</fileset>
				<fileset dir="${lib.project}">
					<include name="**/servlet-api.jar"/>
					<include name="**/jsp-api.jar"/>
				</fileset>
				<fileset dir="${lib.shared}">
					<include name="**/servlet-api.jar"/>
					<include name="**/jsp-api.jar"/>
				</fileset>
			</classpath>
		</javac>
	</target>

	<target name="prepare.cms" depends="prepare.webapp">
		<unjar src="${lib.shared}/ano-site.jar" dest="${webapp.tmp.dir}">
		   <patternset>
		        <include name="**/*.jsp"/>
		    </patternset>
		</unjar>
		<unjar src="${lib.shared}/ano-site.jar" dest="${webapp.classes}">
		   <patternset>
		        <include name="**/*.xml"/>
		    </patternset>
		</unjar>
	</target>

	<target name="prepare.moskito" depends="prepare.webapp">
		<unjar src="${lib.shared}/moskito-webui-jsps.jar" dest="${webapp.tmp.dir}"/>
		<unjar src="${lib.shared}/moskito-webui-config.jar" dest="${webapp.classes}"/>
	</target>
	
	<target name="prepare.ano-web" depends="prepare.webapp">
		<unjar src="${lib.shared}/ano-web.jar" dest="${webapp.tmp.dir}">
			<patternset>
		        <include name="html/**/*"/>
		    </patternset>
			<mapper type="glob" from="html/*" to="*"/>
		</unjar>
	</target>

	<target name="dist.clean" depends="clean">
		<delete dir="${dist.dir}"/>
	</target>

	<target name="dist" depends="buildapp,jar.app,war">
	    <copy todir="${lib.dest}">
	      <fileset dir="${lib.project}"/>
		  <fileset dir="${lib.shared}"/>
	    </copy>
	</target>
	
	<target name="war" depends="compile.webapp.g,compile.webapp,jsps.webapp,prepare.cms,prepare.moskito,prepare.ano-web">
		<mkdir dir="${dist.dir}"/>
		<war warfile="${dist.dir}/${webapp.name}.war" webxml="${etc}/web.xml">
			<fileset dir="${webapp.tmp.dir}"/>
		</war>
		<!-- 
		<copy file="${dist.dir}/${webapp.name}.war" todir="${webapp.dir}"/> 
		-->
	</target>

	<target name="build.web" depends="compile.webapp.g,compile.webapp,jsps.webapp,prepare.cms,prepare.moskito,prepare.ano-web">
		<copy todir="${webapp.dir}/${webapp.name}/">
			<fileset dir="${webapp.tmp.dir}"/>
		</copy>
		<copy file="${etc}/web.xml" todir="${webapp.dir}/${webapp.name}/WEB-INF/"/>
	</target>
	
	<target name="build.web.jsp" depends="jsps.webapp,prepare.cms,prepare.moskito,prepare.ano-web">
			<copy todir="${webapp.dir}/${webapp.name}/">
				<fileset dir="${webapp.tmp.dir}"/>
			</copy>
			<copy file="${etc}/web.xml" todir="${webapp.dir}/${webapp.name}/WEB-INF/"/>
	</target>
	
	<target name="clean.web" depends="clean">
		<delete dir="${webapp.dir}/${webapp.name}/"/>
		<delete file="${webapp.dir}/${webapp.name}.war"/>
	</target>
	
	<target name="all" depends="dist"/>
	
	<target name="javadoc" depends="compile">
		<mkdir dir="${javadoc.dest}/${project.name}"/>
	    <javadoc source="1.5" packagenames="net.anotheria.anosite.*" 
	    	private="true" author="true"
	    	sourcepath="${src}" destdir="${javadoc.dest}/${project.name}" 
	    	bottom="Copyright &#169; 2007 Anotheria.net. All Rights Reserved.&lt;br/&gt;"
		>
		<classpath>
	        <fileset dir="${lib.project}">
	          <include name="**/*.jar"/>
	        </fileset>
	      </classpath>
	      <tag name="created" scope="all" description="Created: " />
	      <link href="http://java.sun.com/j2se/1.5.0/docs/api"/>
	      <link href="http://struts.apache.org/1.x/struts-core/apidocs/"/>
	      <link href="http://java.sun.com/products/servlet/2.2/javadoc/"/>
	      <link href="http://www.jdom.org/docs/apidocs/"/>
	      <link href="http://moskito.anotheria.net/javadoc/core/"/>
	      <link href="http://moskito.anotheria.net/javadoc/web/"/>
	    </javadoc>
	</target>
</project>